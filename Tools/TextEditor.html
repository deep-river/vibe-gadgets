<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网页富文本编辑器 (HTML版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2b579a;
            --bg-color: #f3f2f1;
            --border-color: #e1dfdd;
            --hover-color: #edebe9;
            --text-secondary: #605e5c;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* 主容器布局 */
        .editor-container {
            width: 1000px;
            max-width: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 4px;
            height: 95vh;
            position: relative;
        }

        /* 工具栏 */
        .toolbar {
            padding: 8px 10px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
            user-select: none;
            z-index: 10;
        }

        .divider {
            width: 1px;
            height: 20px;
            background-color: #ccc;
            margin: 0 6px;
        }

        .tool-btn {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 3px;
            cursor: pointer;
            padding: 6px 8px;
            font-size: 14px;
            color: #333;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
        }

        .tool-btn:hover {
            background-color: var(--hover-color);
            color: var(--primary-color);
            border-color: #d0d0d0;
        }

        /* 下拉菜单 */
        select.tool-select {
            padding: 4px;
            border: 1px solid transparent;
            border-radius: 3px;
            background: transparent;
            cursor: pointer;
            font-size: 13px;
            color: #333;
        }
        select.tool-select:hover {
            background-color: var(--hover-color);
        }

        /* 颜色选择器组合样式 */
        .color-group {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 2px;
            gap: 2px;
        }
        
        .color-label {
            padding: 0 4px;
            font-size: 14px;
        }

        input[type="color"] {
            width: 24px;
            height: 24px;
            border: none;
            padding: 0;
            background: none;
            cursor: pointer;
        }

        .confirm-btn {
            background: #e1dfdd;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 2px;
        }
        .confirm-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        /* 编辑区域 */
        .editor-content-wrapper {
            flex: 1;
            background-color: var(--bg-color);
            overflow-y: auto;
            padding: 20px;
            display: flex;
            justify-content: center;
            position: relative;
        }

        #editor {
            width: 210mm;
            min-height: 297mm; /* A4 */
            background: white;
            padding: 25mm 20mm;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            outline: none;
            font-size: 16px;
            line-height: 1.6;
            color: #000;
            margin-bottom: 30px;
        }

        #editor img {
            max-width: 100%;
            height: auto;
            border: 1px solid transparent;
        }
        #editor img:hover {
            border: 1px dashed #2b579a;
        }

        /* 底部状态栏 */
        .status-bar {
            background: #f8f9fa;
            border-top: 1px solid var(--border-color);
            padding: 5px 15px;
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 30px;
        }

        .word-count span {
            font-weight: bold;
            color: #333;
            margin-left: 5px;
        }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }

    </style>
</head>
<body>

<div class="editor-container">
    <div class="toolbar" id="toolbar">
        <button class="tool-btn" onclick="formatDoc('undo')" title="撤销">
            <i class="fas fa-undo"></i>
        </button>
        <button class="tool-btn" onclick="formatDoc('redo')" title="重做">
            <i class="fas fa-redo"></i>
        </button>
        
        <div class="divider"></div>

        <select onchange="formatDoc('formatBlock', this.value); this.selectedIndex=0;" class="tool-select">
            <option value="" selected hidden>段落</option>
            <option value="p">正文</option>
            <option value="h1">标题 1</option>
            <option value="h2">标题 2</option>
            <option value="h3">标题 3</option>
        </select>
        
        <select onchange="formatDoc('fontSize', this.value); this.selectedIndex=0;" class="tool-select">
            <option value="" selected hidden>字号</option>
            <option value="1">小</option>
            <option value="3">正常</option>
            <option value="5">大</option>
            <option value="7">特大</option>
        </select>

        <div class="divider"></div>

        <button class="tool-btn" onclick="formatDoc('bold')" title="加粗">
            <i class="fas fa-bold"></i>
        </button>
        <button class="tool-btn" onclick="formatDoc('italic')" title="斜体">
            <i class="fas fa-italic"></i>
        </button>
        <button class="tool-btn" onclick="formatDoc('underline')" title="下划线">
            <i class="fas fa-underline"></i>
        </button>
        <button class="tool-btn" onclick="formatDoc('strikeThrough')" title="删除线">
            <i class="fas fa-strikethrough"></i>
        </button>

        <div class="divider"></div>

        <div class="color-group" title="文字颜色">
            <span class="color-label"><i class="fas fa-font" style="color: #d32f2f;"></i></span>
            <input type="color" id="foreColorPicker" value="#000000">
            <button class="confirm-btn" onclick="applyColor('foreColor')" title="确认应用颜色">
                <i class="fas fa-check"></i>
            </button>
        </div>
        
        <div class="color-group" title="背景高亮">
            <span class="color-label"><i class="fas fa-highlighter" style="color: #fbc02d;"></i></span>
            <input type="color" id="hiliteColorPicker" value="#ffff00">
            <button class="confirm-btn" onclick="applyColor('hiliteColor')" title="确认应用背景色">
                <i class="fas fa-check"></i>
            </button>
        </div>

        <div class="divider"></div>

        <button class="tool-btn" onclick="formatDoc('justifyLeft')" title="左对齐">
            <i class="fas fa-align-left"></i>
        </button>
        <button class="tool-btn" onclick="formatDoc('justifyCenter')" title="居中">
            <i class="fas fa-align-center"></i>
        </button>
        <button class="tool-btn" onclick="formatDoc('justifyRight')" title="右对齐">
            <i class="fas fa-align-right"></i>
        </button>
        <button class="tool-btn" onclick="formatDoc('justifyFull')" title="两端对齐">
            <i class="fas fa-align-justify"></i>
        </button>

        <div class="divider"></div>

        <button class="tool-btn" onclick="formatDoc('insertOrderedList')" title="有序列表">
            <i class="fas fa-list-ol"></i>
        </button>
        <button class="tool-btn" onclick="formatDoc('insertUnorderedList')" title="无序列表">
            <i class="fas fa-list-ul"></i>
        </button>

        <div class="divider"></div>

        <button class="tool-btn" onclick="addLink()" title="插入链接">
            <i class="fas fa-link"></i>
        </button>
        <button class="tool-btn" onclick="document.getElementById('imgUpload').click()" title="插入图片">
            <i class="fas fa-image"></i>
        </button>
        <input type="file" id="imgUpload" style="display: none;" accept="image/*" onchange="insertImage(this)">

        <button class="tool-btn" onclick="formatDoc('removeFormat')" title="清除格式">
            <i class="fas fa-eraser"></i>
        </button>
        
        <button class="tool-btn" onclick="exportAsHTML()" title="保存为 HTML">
            <i class="fas fa-download"></i>
        </button>
    </div>

    <div class="editor-content-wrapper" onclick="focusEditor(event)">
        <div id="editor" contenteditable="true" spellcheck="false">
            <h1>欢迎使用网页版编辑器</h1>
            <p>此版本已回退至稳定状态，并优化了导出功能。</p>
            <ul>
                <li><b>两端对齐：</b>点击上方 <i class="fas fa-align-justify"></i> 按钮可使文本左右对齐。</li>
                <li><b>颜色确认：</b>选择颜色后，需点击旁边的 <i class="fas fa-check"></i> 确认生效。</li>
                <li><b>导出 HTML：</b>点击工具栏最右侧的下载按钮，直接保存为 .html 文件。</li>
            </ul>
            <p style="text-align: justify;">这里是一段演示两端对齐的长文本。当文本足够长并发生换行时，两侧的文字边缘将会保持平整。这个功能非常适合用于撰写正式文档。</p>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-info">准备就绪</div>
        <div class="word-count">字符数: <span id="charCount">0</span></div>
    </div>
</div>

<script>
    const editor = document.getElementById('editor');
    let savedRange = null; // 选区记忆

    // 监听选区变化
    document.addEventListener('selectionchange', () => {
        const selection = window.getSelection();
        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            if (editor.contains(range.commonAncestorContainer)) {
                savedRange = range.cloneRange();
            }
        }
    });

    /**
     * 核心格式化
     */
    function formatDoc(cmd, value = null) {
        editor.focus(); 
        document.execCommand(cmd, false, value);
        updateStats(); 
    }

    /**
     * 颜色应用（带确认逻辑）
     */
    function applyColor(type) {
        if (savedRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange);
        } else {
            editor.focus();
        }

        let colorVal;
        if (type === 'foreColor') {
            colorVal = document.getElementById('foreColorPicker').value;
        } else if (type === 'hiliteColor') {
            colorVal = document.getElementById('hiliteColorPicker').value;
        }

        document.execCommand(type, false, colorVal);
        
        document.querySelector('.status-info').innerText = `已应用颜色: ${colorVal}`;
        setTimeout(() => { document.querySelector('.status-info').innerText = '准备就绪'; }, 2000);
    }

    /**
     * 字数统计
     */
    function updateStats() {
        const text = editor.innerText || editor.textContent;
        const charCount = text.replace(/\s/g, '').length; 
        document.getElementById('charCount').innerText = charCount;
    }

    editor.addEventListener('input', updateStats);
    updateStats();

    /**
     * 插入链接
     */
    function addLink() {
        if (savedRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange);
        }
        const url = prompt('请输入链接地址:', 'http://');
        if (url) formatDoc('createLink', url);
    }

    /**
     * 插入图片
     */
    function insertImage(input) {
        if (savedRange) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange);
        }
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const html = `<img src="${e.target.result}" style="max-width:100%; margin: 10px 0;">`;
                document.execCommand('insertHTML', false, html);
                updateStats();
            };
            reader.readAsDataURL(file);
            input.value = '';
        }
    }

    /**
     * 导出为 HTML (修改版)
     */
    function exportAsHTML() {
        // 添加一些基础样式，确保导出的HTML在其他地方打开时也好看
        const style = `
            <style>
                body { font-family: 'Segoe UI', sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; line-height: 1.6; color: #333; }
                img { max-width: 100%; height: auto; }
                h1, h2, h3 { color: #2b579a; }
            </style>`;
            
        const htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>导出的文档</title>
${style}
</head>
<body>
${editor.innerHTML}
</body>
</html>`;

        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'document.html'; // 设置下载文件名为 .html
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // 点击空白处聚焦
    function focusEditor(event) {
        if (event.target.classList.contains('editor-content-wrapper')) {
            editor.focus();
            const range = document.createRange();
            range.selectNodeContents(editor);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }
    
    // Tab键处理
    editor.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            document.execCommand('insertText', false, '    ');
            updateStats();
        }
    });
</script>

</body>
</html>